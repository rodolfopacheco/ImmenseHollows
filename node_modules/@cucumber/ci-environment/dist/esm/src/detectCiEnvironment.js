import { CiEnvironments } from './CiEnvironments.js';
import evaluateVariableExpression from './evaluateVariableExpression.js';
export default function detectCiEnvironment(env) {
    for (const ciEnvironment of CiEnvironments) {
        const detected = detect(ciEnvironment, env);
        if (detected) {
            return detected;
        }
    }
}
export function removeUserInfoFromUrl(value) {
    if (!value)
        return value;
    try {
        const url = new URL(value);
        url.password = '';
        url.username = '';
        return url.toString();
    }
    catch (ignore) {
        return value;
    }
}
function detectGit(ciEnvironment, env) {
    var _a, _b, _c, _d;
    const revision = evaluateVariableExpression((_a = ciEnvironment.git) === null || _a === void 0 ? void 0 : _a.revision, env);
    if (!revision) {
        return undefined;
    }
    const remote = evaluateVariableExpression((_b = ciEnvironment.git) === null || _b === void 0 ? void 0 : _b.remote, env);
    if (!remote) {
        return undefined;
    }
    const tag = evaluateVariableExpression((_c = ciEnvironment.git) === null || _c === void 0 ? void 0 : _c.tag, env);
    const branch = evaluateVariableExpression((_d = ciEnvironment.git) === null || _d === void 0 ? void 0 : _d.branch, env);
    return Object.assign(Object.assign({ revision, remote: removeUserInfoFromUrl(remote) }, (tag && { tag })), (branch && { branch }));
}
function detect(ciEnvironment, env) {
    const url = evaluateVariableExpression(ciEnvironment.url, env);
    if (url === undefined) {
        // The url is what consumers will use as the primary key for a build
        // If this cannot be determined, we return nothing.
        return undefined;
    }
    const buildNumber = evaluateVariableExpression(ciEnvironment.buildNumber, env);
    const git = detectGit(ciEnvironment, env);
    return Object.assign({ name: ciEnvironment.name, url,
        buildNumber }, (git && { git }));
}
//# sourceMappingURL=detectCiEnvironment.js.map